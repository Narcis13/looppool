---
phase: 07-ide-server
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ide/lib/security.js
  - ide/lib/tree-builder.js
  - ide/routes/tree.js
  - ide/routes/file.js
autonomous: true

must_haves:
  truths:
    - "Path validation rejects ../etc/passwd and similar traversal attempts"
    - "Host header validation rejects requests with non-localhost Host headers"
    - "Tree builder returns JSON with name, path, type, children for directories"
    - "GET /api/file returns file content for valid paths"
    - "PUT /api/file writes file content for valid paths"
    - "Requests for paths outside allowed directories return 403"
  artifacts:
    - ide/lib/security.js
    - ide/lib/tree-builder.js
    - ide/routes/tree.js
    - ide/routes/file.js
  key_links:
    - "security.js validatePath() used by file.js and tree.js"
    - "security.js validateHost() used by server.js (next plan)"
    - "tree-builder.js buildTree() used by tree.js route handler"
---

<objective>
Create security and file operation foundation for IDE server.

Purpose: Establish secure path validation and file APIs that Phase 8 (IDE Core) will consume.
Output: Security lib, tree builder lib, and route handlers for tree/file endpoints.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ide-server/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security library with path and host validation</name>
  <files>ide/lib/security.js</files>
  <action>
Create `ide/lib/security.js` with two exported functions:

1. `validatePath(requestedPath)` - async function implementing multi-layer path validation:
   - Decode URL-encoded characters
   - Normalize and resolve to absolute path against PROJECT_ROOT (process.cwd())
   - Resolve symlinks via realpath (handle non-existent files for writes by checking parent)
   - Verify path starts with PROJECT_ROOT
   - Verify path is within ALLOWED_DIRS: ['commands', 'looppool', 'agents', '.planning']
   - Throw Error with descriptive message on validation failure
   - Return canonical path on success

2. `validateHost(req)` - function that checks Host header:
   - ALLOWED_HOSTS: ['localhost:3456', '127.0.0.1:3456', '[::1]:3456']
   - Return true if Host header matches allowed hosts, false otherwise

Use ESM imports (node:path, node:fs/promises). Export both functions.
  </action>
  <verify>
Create test script `ide/test-security.js` that:
- Tests validatePath with valid path: 'commands/lpl/plan-phase.md'
- Tests validatePath with traversal attack: '../../../etc/passwd' (should throw)
- Tests validatePath with allowed dir: 'looppool/workflows/execute-plan.md'
- Tests validatePath with disallowed dir: 'node_modules/esbuild/package.json' (should throw)
- Tests validateHost with valid host: { headers: { host: 'localhost:3456' } }
- Tests validateHost with invalid host: { headers: { host: 'evil.com:3456' } }
Run: `node ide/test-security.js`
  </verify>
  <done>All 6 test cases pass. Security functions handle traversal attacks and host validation correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Create tree builder library</name>
  <files>ide/lib/tree-builder.js</files>
  <action>
Create `ide/lib/tree-builder.js` with one exported function:

`buildTree(dir, baseDir)` - async function that:
- Reads directory entries using readdir with { withFileTypes: true }
- For each entry:
  - If directory: recurse and include children
  - If file ending in .md: include as file node
  - Skip other files (non-markdown)
- Return array of nodes sorted: directories first, then alphabetical by name
- Node structure: { name: string, path: string (relative to baseDir), type: 'directory' | 'file', children?: array }

Use ESM imports (node:fs/promises, node:path).
  </action>
  <verify>
Create test script `ide/test-tree.js` that:
- Builds tree for 'commands' directory
- Verifies result is array
- Verifies first-level items have name, path, type properties
- Verifies directories have children arrays
- Verifies files have .md extension
Run: `node ide/test-tree.js`
  </verify>
  <done>Tree builder returns correct JSON structure with directories first, markdown files included.</done>
</task>

<task type="auto">
  <name>Task 3: Create route handlers for tree and file endpoints</name>
  <files>ide/routes/tree.js, ide/routes/file.js</files>
  <action>
Create `ide/routes/tree.js`:
- Export `handleTree(req, res)` async function
- Build combined tree for ALLOWED_DIRS: commands, looppool, agents
- Use buildTree from ../lib/tree-builder.js
- Return JSON response with array of directory trees
- Set Content-Type: application/json
- Handle errors with 500 status

Create `ide/routes/file.js`:
- Export `handleFile(req, res, mode)` async function where mode is 'read' or 'write'
- Parse path from URL query parameter: new URL(req.url, `http://${req.headers.host}`).searchParams.get('path')
- Call validatePath from ../lib/security.js
- For read mode:
  - Read file with fs.readFile
  - Return content with Content-Type: text/plain; charset=utf-8
- For write mode:
  - Collect request body chunks using for await...of
  - Write file with fs.writeFile
  - Return JSON { success: true }
- Handle validation errors with 403 status
- Handle file not found with 404 status
- Handle other errors with 500 status

Use ESM imports throughout.
  </action>
  <verify>
Create test script `ide/test-routes.js` that mocks req/res objects and:
- Tests handleTree returns array of 3 directory trees
- Tests handleFile read mode with valid path returns file content
- Tests handleFile write mode with valid path returns success
- Tests handleFile with invalid path returns 403
Run: `node ide/test-routes.js`
  </verify>
  <done>Route handlers work correctly: tree returns JSON structure, file read/write work with security validation.</done>
</task>

</tasks>

<verification>
Run all test scripts in sequence:
```bash
node ide/test-security.js && node ide/test-tree.js && node ide/test-routes.js
```
All tests pass. No errors.
</verification>

<success_criteria>
- [ ] ide/lib/security.js exports validatePath and validateHost
- [ ] validatePath rejects traversal attacks (../) and non-allowed directories
- [ ] validateHost rejects non-localhost Host headers
- [ ] ide/lib/tree-builder.js exports buildTree
- [ ] buildTree returns correct JSON structure for directory trees
- [ ] ide/routes/tree.js exports handleTree returning combined tree
- [ ] ide/routes/file.js exports handleFile with read/write modes
- [ ] File routes use security validation and return appropriate HTTP status codes
- [ ] All test scripts pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-ide-server/07-01-SUMMARY.md`
</output>
