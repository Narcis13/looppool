---
phase: 07-ide-server
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - ide/lib/watcher.js
  - ide/routes/events.js
  - ide/server.js
  - package.json
autonomous: false

must_haves:
  truths:
    - "Running npm run ide starts server on localhost:3456"
    - "Server opens browser automatically after starting"
    - "File changes in watched directories emit SSE events within 1 second"
    - "SSE connection stays open with keepalive comments"
    - "Server responds to all API routes: /api/tree, /api/file, /api/events"
    - "Server serves 404 for unknown /api/* routes"
  artifacts:
    - ide/lib/watcher.js
    - ide/routes/events.js
    - ide/server.js
    - package.json (updated with ide script and deps)
  key_links:
    - "watcher.js emitter connected to events.js SSE handler"
    - "server.js routes to tree.js, file.js, events.js handlers"
    - "server.js uses security.js validateHost for DNS rebinding protection"
    - "package.json ide script runs node ide/server.js"
---

<objective>
Complete IDE server with real-time file watching and SSE updates.

Purpose: Deliver working server that Phase 8 (IDE Core) frontend can consume.
Output: File watcher, SSE endpoint, server entry point, npm script, and installed dependencies.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ide-server/07-RESEARCH.md
@.planning/phases/07-ide-server/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file watcher library</name>
  <files>ide/lib/watcher.js</files>
  <action>
Create `ide/lib/watcher.js` with one exported function:

`createWatcher(directories)` - function that:
- Uses chokidar to watch provided directories array
- Configure with options:
  - ignored: /(^|[\/\\])\./ (ignore dotfiles)
  - persistent: true
  - awaitWriteFinish: { stabilityThreshold: 300, pollInterval: 100 }
  - depth: 10
- Create EventEmitter instance
- Forward chokidar events to emitter:
  - 'change' -> emit { event: 'change', path }
  - 'add' -> emit { event: 'add', path }
  - 'unlink' -> emit { event: 'unlink', path }
- Return object with:
  - emitter: the EventEmitter instance
  - close: function to close watcher

Use ESM imports (chokidar, node:events).
  </action>
  <verify>
Create test script `ide/test-watcher.js` that:
- Creates watcher for a temp directory
- Writes a test file
- Waits for 'add' event (with 2 second timeout)
- Modifies the test file
- Waits for 'change' event (with 2 second timeout)
- Closes watcher
- Cleans up temp directory
Run: `node ide/test-watcher.js`
  </verify>
  <done>Watcher emits events for file add and change within 2 seconds.</done>
</task>

<task type="auto">
  <name>Task 2: Create SSE events route and server entry point</name>
  <files>ide/routes/events.js, ide/server.js</files>
  <action>
Create `ide/routes/events.js`:
- Export `handleSSE(req, res, emitter)` function
- Set response headers:
  - Content-Type: text/event-stream
  - Cache-Control: no-cache
  - Connection: keep-alive
  - Access-Control-Allow-Origin: *
- Set up keepalive interval (every 30 seconds): res.write(': keepalive\n\n')
- Create sendEvent function: res.write(`data: ${JSON.stringify(data)}\n\n`)
- Register listener on emitter for 'change' event
- On request close:
  - Clear keepalive interval
  - Remove listener from emitter

Create `ide/server.js`:
- Import createServer from node:http
- Import resolve from node:path
- Import open from 'open'
- Import createWatcher from ./lib/watcher.js
- Import validateHost from ./lib/security.js
- Import handleTree from ./routes/tree.js
- Import handleFile from ./routes/file.js
- Import handleSSE from ./routes/events.js

Define:
- PROJECT_ROOT = process.cwd()
- WATCHED_DIRS = ['commands', 'looppool', 'agents'].map(d => resolve(PROJECT_ROOT, d))
- PORT = 3456

Create watcher for WATCHED_DIRS.

Create server with request handler:
- Validate host header first, return 403 if invalid
- Parse URL to get pathname
- Route based on method + pathname:
  - GET /api/tree -> handleTree
  - GET /api/file -> handleFile(req, res, 'read')
  - PUT /api/file -> handleFile(req, res, 'write')
  - GET /api/events -> handleSSE(req, res, watcher.emitter)
  - Other /api/* -> 404
  - Other paths -> 404 (static serving in future phase)

Listen on 127.0.0.1:3456.
On listen callback:
- Log 'GSD IDE running at http://localhost:3456'
- Open browser with open('http://localhost:3456') after 500ms delay (catch errors silently)

Set up graceful shutdown on SIGINT:
- Close watcher
- Close server
- Exit
  </action>
  <verify>
Start server: `node ide/server.js &`
Wait 2 seconds, then:
- curl http://localhost:3456/api/tree (should return JSON)
- curl http://localhost:3456/api/file?path=commands/lpl/plan-phase.md (should return file content)
- curl http://localhost:3456/api/unknown (should return 404)
Kill server process.
  </verify>
  <done>Server starts, routes work, browser opens automatically.</done>
</task>

<task type="auto">
  <name>Task 3: Update package.json with ide script and dependencies</name>
  <files>package.json</files>
  <action>
Update package.json:

1. Add devDependencies (if not present):
   - "chokidar": "^5.0.0"
   - "open": "^11.0.0"

2. Update engines field:
   - "node": ">=20.0.0" (chokidar v5 requires Node 20+)

3. Add scripts entry:
   - "ide": "node ide/server.js"

Run npm install to install new dependencies.
  </action>
  <verify>
Run:
- `npm run ide` (starts server, opens browser)
- Verify server responds to curl http://localhost:3456/api/tree
- Stop server with Ctrl+C
  </verify>
  <done>npm run ide works, dependencies installed, engines field updated.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete IDE server with:
- Security validation (path traversal, DNS rebinding protection)
- File tree API (GET /api/tree)
- File read/write APIs (GET/PUT /api/file)
- Real-time file watching with SSE (GET /api/events)
- npm run ide command with auto browser launch
  </what-built>
  <how-to-verify>
1. Start server: `npm run ide`
2. Browser should open to localhost:3456 (will show 404 - no frontend yet)
3. In terminal, test APIs:
   - `curl http://localhost:3456/api/tree | head -100` (should show JSON tree)
   - `curl "http://localhost:3456/api/file?path=commands/lpl/plan-phase.md" | head -20` (should show file)
   - `curl -X PUT "http://localhost:3456/api/file?path=.planning/test.md" -d "test content"` (should succeed)
   - `curl "http://localhost:3456/api/file?path=.planning/test.md"` (should show "test content")
   - `curl "http://localhost:3456/api/file?path=../../../etc/passwd"` (should return 403)
4. Test SSE (in second terminal while server runs):
   - `curl -N http://localhost:3456/api/events &`
   - Create/modify a file in commands/ directory
   - SSE output should show the change event within 1 second
5. Stop server with Ctrl+C (graceful shutdown)
6. Clean up test file: `rm .planning/test.md`
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Phase 7 success criteria (from roadmap):
1. Running `npm run ide` starts server and opens browser to localhost:3456
2. GET /api/tree returns JSON directory tree of commands/, looppool/, agents/
3. GET /api/file?path=... returns file content for valid paths within allowed directories
4. PUT /api/file?path=... writes content and returns success for valid paths
5. Attempts to access paths outside allowed directories (../ attacks) return 403
6. File changes in watched directories trigger SSE events within 1 second
</verification>

<success_criteria>
- [ ] ide/lib/watcher.js exports createWatcher
- [ ] Watcher emits events for file add/change/unlink
- [ ] ide/routes/events.js exports handleSSE with keepalive
- [ ] ide/server.js wires all routes with host validation
- [ ] Server binds to 127.0.0.1:3456 only
- [ ] Browser opens automatically on server start
- [ ] package.json has ide script and chokidar/open devDependencies
- [ ] package.json engines updated to Node 20+
- [ ] npm run ide works end-to-end
- [ ] Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/07-ide-server/07-02-SUMMARY.md`
</output>
