---
phase: 05-architecture-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agents/gsd-planner.md
  - get-shit-done/references/planner/task-breakdown.md
  - get-shit-done/references/planner/goal-backward.md
  - get-shit-done/references/planner/gap-closure.md
autonomous: true

must_haves:
  truths:
    - "gsd-planner.md is under 500 lines"
    - "Extracted references are self-contained (no missing context)"
    - "@ references in gsd-planner.md point to valid files"
  artifacts:
    - path: "get-shit-done/references/planner/task-breakdown.md"
      provides: "Task anatomy, sizing, TDD detection, user setup detection"
      min_lines: 100
    - path: "get-shit-done/references/planner/goal-backward.md"
      provides: "Goal-backward methodology for must_haves derivation"
      min_lines: 80
    - path: "get-shit-done/references/planner/gap-closure.md"
      provides: "Gap closure planning from verification failures"
      min_lines: 60
  key_links:
    - from: "agents/gsd-planner.md"
      to: "get-shit-done/references/planner/*.md"
      via: "@ reference paths"
      pattern: "@~/.claude/get-shit-done/references/planner/"
---

<objective>
Extract gsd-planner.md (1386 lines) into focused modules under 500 lines each.

Purpose: Reduce planner agent size for maintainability while preserving all functionality through @ references.

Output:
- Slimmed gsd-planner.md (~400-450 lines) with role, philosophy, execution flow
- 3 new reference files in get-shit-done/references/planner/
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-architecture-refactoring/05-RESEARCH.md

# Source file to refactor
@~/.claude/agents/gsd-planner.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create planner references directory and extract task-breakdown.md</name>
  <files>
    get-shit-done/references/planner/task-breakdown.md
  </files>
  <action>
    Create directory get-shit-done/references/planner/ if not exists.

    Extract the following sections from gsd-planner.md into task-breakdown.md:
    - <task_breakdown> section (lines ~119-231) - Task anatomy, sizing, specificity, TDD detection, user setup
    - <scope_estimation> section (lines ~312-379) - Context budget rules, split signals, depth calibration

    Create task-breakdown.md with:
    1. Header explaining this is a planner reference
    2. Task Anatomy section (from task_breakdown)
    3. Task Sizing section (from task_breakdown)
    4. TDD Detection Heuristic (from task_breakdown)
    5. User Setup Detection (from task_breakdown)
    6. Scope Estimation section (from scope_estimation)

    Ensure the reference is self-contained - include any definitions or context needed.
  </action>
  <verify>
    File exists at get-shit-done/references/planner/task-breakdown.md
    wc -l shows 150-250 lines
    Content includes Task Anatomy, Task Sizing, TDD Detection, User Setup Detection, Scope Estimation
  </verify>
  <done>
    task-breakdown.md exists with all task breakdown and scope estimation content
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract goal-backward.md and gap-closure.md</name>
  <files>
    get-shit-done/references/planner/goal-backward.md
    get-shit-done/references/planner/gap-closure.md
  </files>
  <action>
    Extract <goal_backward> section (lines ~492-598) into goal-backward.md:
    - Goal-backward methodology
    - The 5-step process
    - Must-haves output format
    - Common failures

    Extract <gap_closure_mode> section (lines ~801-877) into gap-closure.md:
    - Planning from verification gaps
    - Gap sources (VERIFICATION.md, UAT.md)
    - Gap parsing and clustering
    - Gap closure task format

    Both files need headers explaining their purpose and self-contained context.
  </action>
  <verify>
    goal-backward.md exists, 80-120 lines, contains "Must-Haves Output Format"
    gap-closure.md exists, 60-100 lines, contains "Planning from Verification Gaps"
  </verify>
  <done>
    Both reference files exist with complete, self-contained content
  </done>
</task>

<task type="auto">
  <name>Task 3: Update gsd-planner.md with @ references</name>
  <files>
    agents/gsd-planner.md
  </files>
  <action>
    Replace extracted sections in gsd-planner.md with @ references:

    1. Replace <task_breakdown> content with:
       <task_breakdown>
       @~/.claude/get-shit-done/references/planner/task-breakdown.md
       </task_breakdown>

    2. Remove <scope_estimation> section entirely (content moved to task-breakdown.md)

    3. Replace <goal_backward> content with:
       <goal_backward>
       @~/.claude/get-shit-done/references/planner/goal-backward.md
       </goal_backward>

    4. Replace <gap_closure_mode> content with:
       <gap_closure_mode>
       @~/.claude/get-shit-done/references/planner/gap-closure.md
       </gap_closure_mode>

    Keep these sections INLINE (too small to extract or define agent identity):
    - <role> (identity)
    - <philosophy> (approach)
    - <discovery_levels> (36 lines)
    - <dependency_graph> (78 lines)
    - <plan_format> (110 lines)
    - <checkpoints> (117 lines)
    - <tdd_integration> (81 lines)
    - <revision_mode> (117 lines)
    - <execution_flow> (steps)
    - <structured_returns> (output formats)
    - <success_criteria> (completion checklist)

    Result should be ~400-500 lines.
  </action>
  <verify>
    wc -l agents/gsd-planner.md shows under 550 lines
    grep "@~/.claude/get-shit-done/references/planner/" agents/gsd-planner.md returns 3 matches
    All @ reference paths point to files that exist
  </verify>
  <done>
    gsd-planner.md is under 500 lines with @ references to extracted modules
  </done>
</task>

</tasks>

<verification>
1. gsd-planner.md line count under 500
2. All 3 reference files exist in get-shit-done/references/planner/
3. Each reference file is self-contained (grep for undefined terms)
4. @ paths in gsd-planner.md all point to valid files
</verification>

<success_criteria>
- gsd-planner.md reduced from 1386 to under 500 lines
- 3 reference files created: task-breakdown.md, goal-backward.md, gap-closure.md
- All extracted content preserved in references
- No broken @ paths
- Agent functionality unchanged (references provide same content)
</success_criteria>

<output>
After completion, create `.planning/phases/05-architecture-refactoring/05-01-SUMMARY.md`
</output>
