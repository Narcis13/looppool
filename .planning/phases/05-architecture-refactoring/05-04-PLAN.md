---
phase: 05-architecture-refactoring
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/references/state-schema.md
  - get-shit-done/references/atomic-json.md
  - get-shit-done/workflows/execute-plan.md
  - agents/gsd-planner.md
autonomous: true

must_haves:
  truths:
    - "STATE.md schema has required vs optional fields defined"
    - "Auto-recovery algorithm reconstructs STATE.md from ROADMAP.md"
    - "Atomic JSON pattern documented for config.json edits"
  artifacts:
    - path: "get-shit-done/references/state-schema.md"
      provides: "STATE.md schema definition with required/optional fields and auto-recovery"
      min_lines: 150
    - path: "get-shit-done/references/atomic-json.md"
      provides: "Atomic JSON operations pattern for config.json"
      min_lines: 40
  key_links:
    - from: "agents/gsd-planner.md"
      to: "get-shit-done/references/state-schema.md"
      via: "@ reference in load_project_state"
      pattern: "@~/.claude/get-shit-done/references/state-schema.md"
    - from: "get-shit-done/workflows/execute-plan.md"
      to: "get-shit-done/references/state-schema.md"
      via: "@ reference in load_project_state"
      pattern: "@~/.claude/get-shit-done/references/state-schema.md"
---

<objective>
Create STATE.md schema validation and auto-recovery, plus atomic JSON operations pattern.

Purpose: Prevent STATE.md drift, enable automatic recovery from corruption, ensure safe config.json edits.

Output:
- state-schema.md reference with required/optional fields and auto-recovery algorithm
- atomic-json.md reference with write-temp-verify-move pattern
- Updated references in gsd-planner.md and execute-plan.md load_project_state steps
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-architecture-refactoring/05-RESEARCH.md

# Existing template to extract schema from
@~/.claude/get-shit-done/templates/state.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state-schema.md reference</name>
  <files>
    get-shit-done/references/state-schema.md
  </files>
  <action>
    Create state-schema.md with comprehensive STATE.md schema definition:

    1. Header: "# STATE.md Schema Reference"
    2. Version: 1.0, Last updated date

    3. Required Fields section:
       - Project Reference (REQUIRED)
         * See: path
         * updated: date
         * Core value: string
         * Current focus: string
       - Current Position (REQUIRED)
         * Phase: format "N of M (Name)"
         * Plan: format "A of B in current phase"
         * Status: enum [Ready to plan, Planning, Ready to execute, In progress, Phase complete]
         * Last activity: date + description
         * Progress: visual bar + percentage

    4. Optional Fields section:
       - Performance Metrics (OPTIONAL)
         * Velocity stats
         * By Phase table
         * Recent Trend
       - Accumulated Context (OPTIONAL)
         * Decisions (reference to PROJECT.md)
         * Pending Todos
         * Blockers/Concerns
       - Session Continuity (OPTIONAL)
         * Last session timestamp
         * Stopped at description
         * Resume file path

    5. Auto-Recovery Algorithm section (from 05-RESEARCH.md):
       - When to trigger: STATE.md missing but .planning/ exists
       - Step 1: Check for ROADMAP.md
       - Step 2: Extract phase info (total, first incomplete, name)
       - Step 3: Generate minimal STATE.md with required fields only
       - Step 4: Write and log
       - Recovery template with placeholders

    6. Validation section:
       - How to check required fields
       - grep patterns for validation
       - Error messages for missing fields

    7. Field Addition Process:
       - New required fields: coordinate across all workflows
       - New optional fields: add to template, no coordination needed
  </action>
  <verify>
    File exists at get-shit-done/references/state-schema.md
    wc -l shows 150-220 lines
    Content includes "REQUIRED", "OPTIONAL", "Auto-Recovery Algorithm"
    Content includes recovery template
  </verify>
  <done>
    state-schema.md exists with complete schema definition and auto-recovery algorithm
  </done>
</task>

<task type="auto">
  <name>Task 2: Create atomic-json.md reference</name>
  <files>
    get-shit-done/references/atomic-json.md
  </files>
  <action>
    Create atomic-json.md with atomic JSON operations pattern:

    1. Header: "# Atomic JSON Operations Reference"

    2. Problem Statement:
       - JSON files (config.json) can corrupt on interrupted writes
       - Partial writes leave invalid JSON
       - Need atomic update pattern

    3. Pattern section (write-temp-verify-move):
       ```bash
       # 1. Read current config
       CONFIG=$(cat .planning/config.json 2>/dev/null || echo '{}')

       # 2. Modify in memory
       NEW_CONFIG=$(echo "$CONFIG" | jq '.key = "value"')

       # 3. Write to temp file
       echo "$NEW_CONFIG" > .planning/config.json.tmp

       # 4. Verify temp file is valid JSON
       if ! jq empty .planning/config.json.tmp 2>/dev/null; then
         rm .planning/config.json.tmp
         echo "ERROR: JSON validation failed, config unchanged"
         exit 1
       fi

       # 5. Atomic move (replaces original)
       mv .planning/config.json.tmp .planning/config.json
       ```

    4. Error Recovery section:
       - If .tmp file exists alongside original: interrupted write
       - Pre-flight check: rm -f .planning/config.json.tmp
       - Original always preserved until successful validation

    5. When to Use section:
       - config.json edits
       - Any JSON file that must remain valid
       - NOT needed for markdown files (partial markdown is still readable)
  </action>
  <verify>
    File exists at get-shit-done/references/atomic-json.md
    wc -l shows 50-80 lines
    Content includes "jq empty", "config.json.tmp", "mv"
  </verify>
  <done>
    atomic-json.md exists with atomic JSON operations pattern
  </done>
</task>

<task type="auto">
  <name>Task 3: Update load_project_state steps with schema reference</name>
  <files>
    agents/gsd-planner.md
    get-shit-done/workflows/execute-plan.md
  </files>
  <action>
    Update the load_project_state step in both files to reference state-schema.md.

    In gsd-planner.md, update <step name="load_project_state"> to add after the "If STATE.md missing" block:

    ```
    **For STATE.md schema and auto-recovery:**
    @~/.claude/get-shit-done/references/state-schema.md
    ```

    In execute-plan.md, update <step name="load_project_state"> similarly.

    Also update both files' config.json reading sections to reference atomic-json.md:

    ```
    **For atomic config.json operations:**
    See @~/.claude/get-shit-done/references/atomic-json.md
    ```

    This ensures:
    - STATE.md recovery is documented and accessible
    - Config.json edits follow atomic pattern
    - Both planner and workflow have consistent state handling
  </action>
  <verify>
    grep "state-schema.md" agents/gsd-planner.md returns match
    grep "state-schema.md" get-shit-done/workflows/execute-plan.md returns match
    grep "atomic-json.md" agents/gsd-planner.md returns match (or in config loading section)
  </verify>
  <done>
    Both gsd-planner.md and execute-plan.md reference state-schema.md and atomic-json.md
  </done>
</task>

</tasks>

<verification>
1. state-schema.md exists with required/optional field definitions
2. state-schema.md includes auto-recovery algorithm
3. atomic-json.md exists with write-temp-verify-move pattern
4. gsd-planner.md references state-schema.md
5. execute-plan.md references state-schema.md
6. Config.json operations documented with atomic pattern
</verification>

<success_criteria>
- STATE.md schema formally defined with required vs optional fields
- Auto-recovery algorithm documented and accessible
- Atomic JSON pattern documented
- References added to planner and workflow load_project_state steps
- DEBT-04, DEBT-05, DEBT-06 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-architecture-refactoring/05-04-SUMMARY.md`
</output>
