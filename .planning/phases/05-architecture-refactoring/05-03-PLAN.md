---
phase: 05-architecture-refactoring
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - get-shit-done/workflows/execute-plan.md
  - get-shit-done/references/execute-plan/segment-routing.md
  - get-shit-done/references/execute-plan/offer-next.md
autonomous: true

must_haves:
  truths:
    - "execute-plan.md is under 800 lines"
    - "Duplicated deviation_rules removed (references executor)"
    - "Duplicated authentication_gates removed (references executor)"
    - "Segment routing logic extracted to reference"
  artifacts:
    - path: "get-shit-done/references/execute-plan/segment-routing.md"
      provides: "Segment parsing, routing rules, execution patterns"
      min_lines: 150
    - path: "get-shit-done/references/execute-plan/offer-next.md"
      provides: "Next step routing logic (Route A, B, C)"
      min_lines: 100
  key_links:
    - from: "get-shit-done/workflows/execute-plan.md"
      to: "get-shit-done/references/execute-plan/*.md"
      via: "@ reference paths"
      pattern: "@~/.claude/get-shit-done/references/execute-plan/"
    - from: "get-shit-done/workflows/execute-plan.md"
      to: "get-shit-done/references/executor/deviation-rules.md"
      via: "@ reference"
      pattern: "@~/.claude/get-shit-done/references/executor/deviation-rules.md"
---

<objective>
Extract execute-plan.md (1844 lines) into focused modules and deduplicate shared content.

Purpose: Reduce workflow size, eliminate duplication with executor agent, improve maintainability.

Output:
- Slimmed execute-plan.md (~700-800 lines) with orchestration logic
- 2 new reference files in get-shit-done/references/execute-plan/
- Removal of duplicated content (deviation_rules, authentication_gates, task_commit)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-architecture-refactoring/05-RESEARCH.md

# Source file to refactor
@~/.claude/get-shit-done/workflows/execute-plan.md

# Reference newly created executor references (from 05-02)
@~/.claude/get-shit-done/references/executor/deviation-rules.md
@~/.claude/get-shit-done/references/executor/checkpoint-protocol.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create execute-plan references directory and extract segment-routing.md</name>
  <files>
    get-shit-done/references/execute-plan/segment-routing.md
  </files>
  <action>
    Create directory get-shit-done/references/execute-plan/ if not exists.

    Extract these sections into segment-routing.md:
    - Step parse_segments (lines ~154-300) - Segment parsing and routing logic
    - Step init_agent_tracking (lines ~302-348) - Agent tracking infrastructure
    - Step segment_execution (lines ~350-525) - Segment execution loop

    Create segment-routing.md with:
    1. Header: "# Execute-Plan Segment Routing Reference"
    2. Overview of segmentation purpose
    3. Segment Parsing section (how to identify segments from checkpoints)
    4. Routing Rules section (subagent vs main context decisions)
    5. Execution Patterns section (Pattern A, B, C)
    6. Agent Tracking section (agent-history.json, resume detection)
    7. Segment Execution Loop section (detailed flow)

    This is the most complex extraction - preserve all decision logic.
  </action>
  <verify>
    File exists at get-shit-done/references/execute-plan/segment-routing.md
    wc -l shows 180-250 lines
    Content includes "Pattern A", "Pattern B", "Pattern C", "agent_id"
  </verify>
  <done>
    segment-routing.md exists with complete segment routing and tracking logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract offer-next.md</name>
  <files>
    get-shit-done/references/execute-plan/offer-next.md
  </files>
  <action>
    Extract step offer_next (lines ~1634-1830) into offer-next.md:
    - USER-SETUP.md warning block
    - Step 1: Count plans and summaries
    - Step 2: Route based on plan completion
    - Route A: More plans remain
    - Step 3: Check milestone status
    - Step 4: Route based on milestone status
    - Route B: Phase complete, more phases remain
    - Route C: Milestone complete

    Create offer-next.md with:
    1. Header: "# Execute-Plan Offer Next Reference"
    2. Overview of completion routing
    3. All routes (A, B, C) with templates
    4. Mode handling (yolo vs interactive)

    Preserve all the completion message templates exactly.
  </action>
  <verify>
    File exists at get-shit-done/references/execute-plan/offer-next.md
    wc -l shows 120-180 lines
    Content includes "Route A", "Route B", "Route C", "MILESTONE COMPLETE"
  </verify>
  <done>
    offer-next.md exists with complete completion routing logic
  </done>
</task>

<task type="auto">
  <name>Task 3: Update execute-plan.md with @ references and remove duplicates</name>
  <files>
    get-shit-done/workflows/execute-plan.md
  </files>
  <action>
    1. Replace parse_segments, init_agent_tracking, segment_execution steps with:
       <step name="segment_routing">
       @~/.claude/get-shit-done/references/execute-plan/segment-routing.md
       </step>

    2. Replace step offer_next content with:
       <step name="offer_next">
       @~/.claude/get-shit-done/references/execute-plan/offer-next.md
       </step>

    3. REMOVE duplicated sections (these exist in executor references now):
       - Remove <deviation_rules> section (lines ~691-850) - use reference:
         <deviation_rules>
         @~/.claude/get-shit-done/references/executor/deviation-rules.md
         </deviation_rules>

       - Remove <authentication_gates> section (lines ~595-689) - reference executor's checkpoint-protocol.md:
         <authentication_gates>
         See @~/.claude/get-shit-done/references/executor/checkpoint-protocol.md for authentication gate handling.
         </authentication_gates>

       - Remove <deviation_documentation> section (lines ~852-905) - keep brief inline note

       - Remove <task_commit> section (lines ~964-1048) - this duplicates executor's task_commit_protocol:
         <task_commit>
         See @~/.claude/agents/gsd-executor.md <task_commit_protocol> section.
         </task_commit>

    4. Keep these sections INLINE (workflow-specific, not duplicated):
       - <purpose>
       - <required_reading>
       - <process> wrapper
       - All steps not extracted: resolve_model_profile, load_project_state, identify_plan, record_start_time, load_prompt, previous_phase_check, execute, checkpoint_protocol, checkpoint_return_for_orchestrator, verification_failure_gate, record_completion_time, generate_user_setup, create_summary, update_current_position, extract_decisions_and_issues, update_session_continuity, issues_review_gate, update_roadmap, git_commit_metadata, update_codebase_map
       - <tdd_plan_execution> (workflow-specific TDD)
       - <success_criteria>

    Result should be ~700-800 lines.
  </action>
  <verify>
    wc -l get-shit-done/workflows/execute-plan.md shows under 850 lines
    grep "@~/.claude/get-shit-done/references/execute-plan/" execute-plan.md returns 2 matches
    grep "@~/.claude/get-shit-done/references/executor/" execute-plan.md returns 1+ matches
    grep -c "RULE 1: Auto-fix bugs" execute-plan.md returns 0 (removed duplicate)
  </verify>
  <done>
    execute-plan.md under 800 lines, duplicates removed, @ references working
  </done>
</task>

</tasks>

<verification>
1. execute-plan.md line count under 800
2. Both reference files exist in get-shit-done/references/execute-plan/
3. Duplicated deviation_rules removed (grep returns 0 for "RULE 1")
4. Duplicated authentication_gates removed
5. Duplicated task_commit removed
6. All @ paths point to valid files
</verification>

<success_criteria>
- execute-plan.md reduced from 1844 to under 800 lines
- 2 reference files created: segment-routing.md, offer-next.md
- Duplicated content removed (deviation_rules, authentication_gates, task_commit)
- References point to executor modules for shared content
- No broken @ paths
- Workflow functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/05-architecture-refactoring/05-03-SUMMARY.md`
</output>
