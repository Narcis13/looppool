---
phase: 03-decision-policies
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - commands/gsd/new-project.md
autonomous: true

must_haves:
  truths:
    - "POLICY-01 auto-triggers codebase mapping when code exists without map"
    - "POLICY-02 auto-enables research for greenfield projects"
    - "POLICY-03 auto-classifies features as v1/v2"
    - "POLICY-04 auto-approves roadmap when 100% coverage"
  artifacts:
    - path: "commands/gsd/new-project.md"
      provides: "Autonomous policy handling for project initialization"
      contains: "POLICY-01"
  key_links:
    - from: "commands/gsd/new-project.md"
      to: "get-shit-done/references/decision-policies.md"
      via: "reference to policy definitions"
      pattern: "decision-policies.md"
---

<objective>
Integrate autonomous policy handling into new-project.md for POLICY-01, POLICY-02, POLICY-03, and POLICY-04.

Purpose: Enable `/gsd:new-project` to run end-to-end with zero human input when autonomous mode is enabled, using defined policies for each decision point.

Output: Updated `commands/gsd/new-project.md` with autonomous wrappers at each policy decision point.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-decision-policies/03-01-SUMMARY.md

Reference:
@commands/gsd/new-project.md
@get-shit-done/references/decision-policies.md
@get-shit-done/references/autonomous.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add autonomous flag reading and POLICY-01/02 to new-project.md</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Update `commands/gsd/new-project.md` to add autonomous policy handling.

**Step 1: Add execution_context reference**

Add to the `<execution_context>` section:
```markdown
@~/.claude/get-shit-done/references/decision-policies.md
@~/.claude/get-shit-done/references/autonomous.md
```

**Step 2: Add autonomous flag reading after Phase 1 Setup**

After the setup checks (git init, brownfield detection), add:
```markdown
4. **Check autonomous mode:**
   ```bash
   AUTONOMOUS=$(cat .planning/config.json 2>/dev/null | grep -o '"autonomous"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
   ```
   Store for use in decision points below.
```

**Step 3: Update Phase 2 (Brownfield Offer) with POLICY-01**

Replace the existing brownfield offer logic with autonomous wrapper:

```markdown
## Phase 2: Brownfield Offer

**If existing code detected and .planning/codebase/ doesn't exist:**

Check the results from setup step:
- If `CODE_FILES` is non-empty OR `HAS_PACKAGE` is "yes"
- AND `HAS_CODEBASE_MAP` is NOT "yes"

**If AUTONOMOUS=true:**

Apply POLICY-01 (Brownfield Detection):
```
Auto-decided: map codebase -- Code exists without map, mapping required [POLICY-01, file: {CODE_FILES first match}]
```
Run `/gsd:map-codebase`, then return to `/gsd:new-project`.
Exit command.

**If AUTONOMOUS=false:**

Use AskUserQuestion:
- header: "Existing Code"
- question: "I detected existing code in this directory. Would you like to map the codebase first?"
- options:
  - "Map codebase first" -- Run /gsd:map-codebase to understand existing architecture (Recommended)
  - "Skip mapping" -- Proceed with project initialization

**If "Map codebase first":**
[... existing flow ...]
```

**Step 4: Update Phase 6 (Research Decision) with POLICY-02**

Replace the research decision with autonomous wrapper:

```markdown
## Phase 6: Research Decision

**If AUTONOMOUS=true:**

Apply POLICY-02 (Research Toggle):

1. Check config:
   ```bash
   WORKFLOW_RESEARCH=$(cat .planning/config.json 2>/dev/null | grep -o '"research"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "true")
   ```

2. Check if greenfield:
   ```bash
   GREENFIELD=$([ ! -d .planning/codebase ] && echo "yes")
   ```

3. Apply policy:
   - If WORKFLOW_RESEARCH=true AND GREENFIELD=yes:
     ```
     Auto-decided: research enabled -- Greenfield project, domain research beneficial [POLICY-02, config: workflow.research=true]
     ```
     Proceed to research.

   - If WORKFLOW_RESEARCH=false:
     ```
     Auto-decided: skip research -- Research disabled in config [POLICY-02, config: workflow.research=false]
     ```
     Skip to Phase 7.

   - If not greenfield (has codebase map):
     ```
     Auto-decided: skip research -- Brownfield with codebase map [POLICY-02, .planning/codebase exists]
     ```
     Skip to Phase 7.

**If AUTONOMOUS=false:**

Use AskUserQuestion:
- header: "Research"
- question: "Research the domain ecosystem before defining requirements?"
- options:
  - "Research first (Recommended)" -- Discover standard stacks, expected features, architecture patterns
  - "Skip research" -- I know this domain well, go straight to requirements
```

Note: Interactive mode code paths must remain IDENTICAL to current implementation. Autonomy is additive.
  </action>
  <verify>
References added: `grep -q "decision-policies.md" commands/gsd/new-project.md`
Autonomous flag check exists: `grep -q "AUTONOMOUS=" commands/gsd/new-project.md`
POLICY-01 integrated: `grep -q "POLICY-01" commands/gsd/new-project.md`
POLICY-02 integrated: `grep -q "POLICY-02" commands/gsd/new-project.md`
  </verify>
  <done>
new-project.md has autonomous flag reading, POLICY-01 for brownfield detection, and POLICY-02 for research toggle, with preserved interactive paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add POLICY-03 and POLICY-04 to new-project.md</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Continue updating `commands/gsd/new-project.md` with POLICY-03 and POLICY-04.

**Step 1: Add POLICY-03 to Phase 7 (Requirements Definition)**

After research completes (or is skipped), when defining requirements:

```markdown
## Phase 7: Define Requirements

[... existing requirement gathering logic ...]

**Feature Scoping (when FEATURES.md exists from research):**

**If AUTONOMOUS=true:**

Apply POLICY-03 (Feature Scoping):

For each feature identified:

1. Check if table stakes:
   ```bash
   grep -q "[feature]" .planning/research/FEATURES.md && grep -B5 "[feature]" .planning/research/FEATURES.md | grep -q "Table stakes"
   ```

2. Check if in PROJECT.md:
   ```bash
   grep -qi "[feature]" .planning/PROJECT.md
   ```

3. Apply policy:
   - If table stakes OR in PROJECT.md:
     ```
     Auto-decided: v1 -- Table stakes feature ({feature}) [POLICY-03, FEATURES.md:Table stakes]
     ```
     or
     ```
     Auto-decided: v1 -- Explicit PROJECT.md mention ({feature}) [POLICY-03, PROJECT.md]
     ```

   - If differentiator NOT in PROJECT.md:
     ```
     Auto-decided: v2 -- Differentiator not in PROJECT.md ({feature}) [POLICY-03, FEATURES.md:Differentiators]
     ```

**If AUTONOMOUS=false:**

[Interactive scoping - unchanged]
```

**Step 2: Add POLICY-04 to Phase 8 (Roadmap Creation)**

After roadmapper creates ROADMAP.md:

```markdown
## Phase 8: Roadmap Approval

After roadmapper returns ROADMAP.md:

**If AUTONOMOUS=true:**

Apply POLICY-04 (Roadmap Approval):

1. Check for unmapped requirements:
   ```bash
   UNMAPPED=$(grep -c "Pending" .planning/REQUIREMENTS.md 2>/dev/null || echo "0")
   ```

2. Count mapped vs total:
   ```bash
   V1_COUNT=$(grep -c "^\- \[ \]" .planning/REQUIREMENTS.md 2>/dev/null || echo "0")
   MAPPED_COUNT=$(grep -c "Phase [0-9]" .planning/REQUIREMENTS.md 2>/dev/null || echo "0")
   ```

3. Apply policy:
   - If UNMAPPED=0 AND MAPPED_COUNT >= V1_COUNT:
     ```
     Auto-decided: approve roadmap -- 100% requirement coverage, deps satisfied [POLICY-04, {MAPPED_COUNT}/{V1_COUNT} requirements mapped]
     ```
     Proceed to Phase 9.

   - If UNMAPPED > 0 or coverage incomplete:
     ```
     Auto-decided: request revision -- Incomplete coverage ({UNMAPPED} unmapped) [POLICY-04]
     ```
     Request roadmapper revision (up to 2 iterations), then fall back to human if still incomplete.

**If AUTONOMOUS=false:**

Use AskUserQuestion:
- header: "Roadmap Review"
- question: "Review the roadmap. Ready to proceed?"
- options:
  - "Approve and continue"
  - "Request revision"
  - "Exit and review manually"
```

Note: Keep existing interactive paths unchanged. Only add autonomous wrapper.
  </action>
  <verify>
POLICY-03 integrated: `grep -q "POLICY-03" commands/gsd/new-project.md`
POLICY-04 integrated: `grep -q "POLICY-04" commands/gsd/new-project.md`
Feature scoping logic: `grep -q "Table stakes" commands/gsd/new-project.md`
Coverage check: `grep -q "UNMAPPED" commands/gsd/new-project.md`
  </verify>
  <done>
new-project.md has POLICY-03 for feature scoping (v1/v2 classification) and POLICY-04 for roadmap approval, with preserved interactive paths.
  </done>
</task>

</tasks>

<verification>
- [ ] Autonomous flag reading added to new-project.md
- [ ] POLICY-01 (brownfield) applied in Phase 2
- [ ] POLICY-02 (research) applied in Phase 6
- [ ] POLICY-03 (scoping) applied in Phase 7
- [ ] POLICY-04 (roadmap) applied in Phase 8
- [ ] All interactive paths preserved unchanged
- [ ] Reference to decision-policies.md added
</verification>

<success_criteria>
`/gsd:new-project` can run from start to roadmap creation with zero human input when `autonomous: true` is set, using defined policies at each decision point. Interactive mode remains unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/03-decision-policies/03-02-SUMMARY.md`
</output>
