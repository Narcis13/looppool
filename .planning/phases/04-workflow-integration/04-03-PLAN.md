---
phase: 04-workflow-integration
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - commands/gsd/new-milestone.md
autonomous: true

must_haves:
  truths:
    - "new-milestone respects autonomous flag for all decision points"
    - "Research toggle, requirements scoping, roadmap approval handled autonomously"
    - "Interactive paths remain unchanged when autonomous disabled"
  artifacts:
    - path: "commands/gsd/new-milestone.md"
      provides: "Autonomous flag reading, policy integration for milestone decisions"
      contains: "AUTONOMOUS="
  key_links:
    - from: "commands/gsd/new-milestone.md"
      to: "get-shit-done/references/decision-policies.md"
      via: "execution_context reference"
      pattern: "@~/.claude/get-shit-done/references/decision-policies.md"
---

<objective>
Add autonomous handling to new-milestone command, mirroring the patterns established in new-project.md (Phase 3).

Purpose: FLOW-04 requires all GSD workflows to check autonomous flag. new-milestone is the brownfield equivalent of new-project and has similar decision points: research toggle, feature scoping, roadmap approval.

Output: new-milestone.md with autonomous flag reading and policy-based autonomous decisions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/autonomous.md
@~/.claude/get-shit-done/references/decision-policies.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference: commands/gsd/new-project.md has POLICY-01/02/03/04 integrated (from 03-02-SUMMARY.md)
Mirror those patterns here for consistency.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add autonomous flag reading and references to new-milestone</name>
  <files>commands/gsd/new-milestone.md</files>
  <action>
Add autonomous.md and decision-policies.md to execution_context:

```markdown
<execution_context>
@~/.claude/get-shit-done/references/questioning.md
@~/.claude/get-shit-done/references/ui-brand.md
@~/.claude/get-shit-done/templates/project.md
@~/.claude/get-shit-done/templates/requirements.md
@~/.claude/get-shit-done/references/autonomous.md
@~/.claude/get-shit-done/references/decision-policies.md
</execution_context>
```

Add autonomous flag reading in Phase 1 (Load Context) section. Insert after loading context files:

```markdown
## Phase 1: Load Context

- Read PROJECT.md (existing project, Validated requirements, decisions)
- Read MILESTONES.md (what shipped previously)
- Read STATE.md (pending todos, blockers)
- Check for MILESTONE-CONTEXT.md (from /gsd:discuss-milestone)

**Read autonomous mode:**

```bash
AUTONOMOUS=$(cat .planning/config.json 2>/dev/null | grep -o '"autonomous"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
```

Store for use in decision points below.
```
  </action>
  <verify>
grep "AUTONOMOUS=" commands/gsd/new-milestone.md
grep "autonomous.md" commands/gsd/new-milestone.md
grep "decision-policies.md" commands/gsd/new-milestone.md
  </verify>
  <done>
new-milestone has AUTONOMOUS flag reading in Phase 1 and references autonomous.md/decision-policies.md.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add POLICY-02 integration for research toggle</name>
  <files>commands/gsd/new-milestone.md</files>
  <action>
Modify Phase 7 (Research Decision) to add autonomous handling.

Replace the current Phase 7 section:

```markdown
## Phase 7: Research Decision

**If AUTONOMOUS=true:**

Apply POLICY-02 (Research Toggle):

Check if research should be auto-enabled:
```bash
# Check config for research setting
RESEARCH_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"research"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "true")
```

If config workflow.research=true (default for subsequent milestones with new features):

```
Auto-decided: research enabled -- Config workflow.research=true, new milestone features [POLICY-02, config: workflow.research=true]
```

Proceed to research phase (spawn researchers).

If config workflow.research=false:

```
Auto-decided: skip research -- Config workflow.research=false [POLICY-02, config: workflow.research=false]
```

Skip to Phase 8 (Define Requirements).

**If AUTONOMOUS=false:**

Use AskUserQuestion:
- header: "Research"
- question: "Research the domain ecosystem for new features before defining requirements?"
- options:
  - "Research first (Recommended)" — Discover patterns, expected features, architecture for NEW capabilities
  - "Skip research" — I know what I need, go straight to requirements

**If "Research first":**
[... existing research spawning code unchanged ...]
```
  </action>
  <verify>
grep "POLICY-02" commands/gsd/new-milestone.md
grep "research enabled" commands/gsd/new-milestone.md
  </verify>
  <done>
new-milestone Phase 7 has POLICY-02 integration with autonomous wrapper.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add autonomous handling for roadmap approval</name>
  <files>commands/gsd/new-milestone.md</files>
  <action>
Modify Phase 9 (Create Roadmap) section to add autonomous roadmap approval.

Find the "CRITICAL: Ask for approval before committing" section and wrap it with autonomous handling:

```markdown
**Handle roadmapper return:**

**If `## ROADMAP BLOCKED`:**
- Present blocker information
- Work with user to resolve
- Re-spawn when resolved

**If `## ROADMAP CREATED`:**

Read the created ROADMAP.md and present it nicely inline:
[... existing presentation code ...]

**If AUTONOMOUS=true:**

Apply POLICY-04 (Roadmap Approval):

Verify coverage:
```bash
# Count requirements from REQUIREMENTS.md
TOTAL_REQS=$(grep -c "^\- \[ \]" .planning/REQUIREMENTS.md 2>/dev/null || echo "0")
# Count mapped requirements in ROADMAP.md
MAPPED_REQS=$(grep -oE '[A-Z]+-[0-9]+' .planning/ROADMAP.md 2>/dev/null | sort -u | wc -l | tr -d ' ')
```

If 100% coverage (MAPPED_REQS >= TOTAL_REQS):
```
Auto-decided: approve roadmap -- 100% requirement coverage [POLICY-04, {MAPPED_REQS}/{TOTAL_REQS}]
```
Continue to commit.

If coverage incomplete, retry once:
- Re-spawn roadmapper with revision context
- Check again
- If still incomplete after retry: fall back to human approval

```
Auto-decided: human review needed -- Coverage incomplete after retry [POLICY-04, {MAPPED_REQS}/{TOTAL_REQS}]
```

**If AUTONOMOUS=false:**

Use AskUserQuestion:
- header: "Roadmap"
- question: "Does this roadmap structure work for you?"
- options:
  - "Approve" — Commit and continue
  - "Adjust phases" — Tell me what to change
  - "Review full file" — Show raw ROADMAP.md

[... rest of existing interactive handling unchanged ...]
```
  </action>
  <verify>
grep "POLICY-04" commands/gsd/new-milestone.md
grep "approve roadmap" commands/gsd/new-milestone.md
  </verify>
  <done>
new-milestone Phase 9 has POLICY-04 integration with autonomous wrapper and retry logic.
  </done>
</task>

</tasks>

<verification>
1. grep confirms AUTONOMOUS flag reading exists
2. grep confirms POLICY-02 trace for research toggle
3. grep confirms POLICY-04 trace for roadmap approval
4. Interactive paths (AUTONOMOUS=false) identical to original
5. Patterns mirror new-project.md structure from Phase 3
</verification>

<success_criteria>
- [ ] new-milestone reads AUTONOMOUS flag in Phase 1
- [ ] Research toggle has POLICY-02 autonomous handling
- [ ] Roadmap approval has POLICY-04 autonomous handling with retry
- [ ] execution_context references autonomous.md and decision-policies.md
- [ ] Interactive paths unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/04-workflow-integration/04-03-SUMMARY.md`
</output>
